version: '3.8'

services:
  # ─────────────────────────────────────────────────────
  # Container 1: The Scraper (Read-Only Config)
  # Fetches news from APIs, writes to shared volume.
  # No LLM access, no internet write access.
  # ─────────────────────────────────────────────────────
  scraper:
    build: ./scraper
    volumes:
      - news_data:/data:rw
      - ./scraper/config.yaml:/app/config.yaml:ro
    networks:
      - scraper_net
    environment:
      - NEWS_API_KEY=${NEWS_API_KEY}
    restart: on-failure
    cap_drop:
      - ALL
    cap_add:
      - NET_RAW  # Needed for DNS resolution
    security_opt:
      - no-new-privileges:true

  # ─────────────────────────────────────────────────────
  # Container 2: The Writer (Sandboxed)
  # Reads news (read-only), generates drafts via Claude.
  # NO access to social media APIs.
  # Network restricted to anthropic.com only.
  # ─────────────────────────────────────────────────────
  writer:
    build: ./writer
    volumes:
      - news_data:/data/news:ro       # Can ONLY read news
      - drafts:/data/drafts:rw        # Writes drafts here
      - rag_data:/app/rag:ro          # RAG database (read-only)
    networks:
      - writer_net                    # Isolated network
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    depends_on:
      - scraper
    cap_drop:
      - ALL                           # Drop all Linux capabilities
    security_opt:
      - no-new-privileges:true
    read_only: true                   # Root filesystem is read-only
    tmpfs:
      - /tmp                          # Only /tmp is writable

  # ─────────────────────────────────────────────────────
  # Container 3: The Publisher (Human-Gated)
  # Reads approved drafts only after HITL via Slack.
  # Has social media API keys.
  # ─────────────────────────────────────────────────────
  publisher:
    build: ./publisher
    ports:
      - "5000:5000"                   # Flask webhook receiver
    volumes:
      - drafts:/data/drafts:ro        # Reads drafts (read-only)
      - approved:/data/approved:rw    # Writes approved posts
    networks:
      - publisher_net
    environment:
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN}
      - SLACK_SIGNING_SECRET=${SLACK_SIGNING_SECRET}
      - SLACK_APPROVAL_CHANNEL=${SLACK_APPROVAL_CHANNEL}
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL}
      - TWITTER_API_KEY=${TWITTER_API_KEY}
      - TWITTER_API_SECRET=${TWITTER_API_SECRET}
      - TWITTER_ACCESS_TOKEN=${TWITTER_ACCESS_TOKEN}
      - TWITTER_ACCESS_SECRET=${TWITTER_ACCESS_SECRET}
      - LINKEDIN_ACCESS_TOKEN=${LINKEDIN_ACCESS_TOKEN}
      - LINKEDIN_ORG_ID=${LINKEDIN_ORG_ID}
    depends_on:
      - writer
    cap_drop:
      - ALL
    cap_add:
      - NET_RAW
    security_opt:
      - no-new-privileges:true

volumes:
  news_data:
    driver: local
  drafts:
    driver: local
  approved:
    driver: local
  rag_data:
    driver: local

networks:
  scraper_net:
    driver: bridge
  writer_net:
    driver: bridge
    internal: true                    # No external access except whitelisted
    driver_opts:
      com.docker.network.bridge.name: clawdbot_writer
    ipam:
      config:
        - subnet: 172.28.0.0/16
  publisher_net:
    driver: bridge
